PLAN FINAL — Hitos, Tickets y Reglas de PR

Fecha: 20251017-0304

Prioridades (orden de ejecución)
1) Seguridad Caja y Kernel
   - Título: Proteger /api/caja/* con auth/roles y normalizar Kernel
   - Descripción: aplicar middleware auth (Sanctum/JWT) + permission (spatie), mover configuración a app/Http/Kernel.php y registrar ApiResponseMiddleware con throttle/bindings.
   - Archivos: routes/api.php; app/Http/Kernel.php; app/Http/Middleware/ApiResponseMiddleware.php; config/auth.php
   - Estimado: 2–3 días; Riesgos: impacto en front; sesiones.

2) Wizard Cortes — IDs/guardias/name/store
   - Título: Estabilizar wizard (IDs consistentes, puedeWizard real, name= inputs, store_id desde backend)
   - Descripción: unificar #wizardPrecorte/#czModalPrecorte; reactivar lógica de puedeWizard; añadir name a inputs; derivar store_id del API.
   - Archivos: resources/views/caja/_wizard_modals.php; public/assets/js/caja/{wizard.js,state.js,mainTable.js}
   - Estimado: 1–2 días; Riesgos: regresiones UI.

3) FormRequests Caja (Precorte/Postcorte)
   - Título: Validaciones fuertes para precorte/postcorte
   - Descripción: crear Requests con reglas (denoms>0, montos>=0, decimales, notas maxlen, validado boolean); wiring en controladores; mensajes claros.
   - Archivos: app/Http/Requests/Caja/*; app/Http/Controllers/Api/Caja/*
   - Estimado: 1–2 días; Riesgos: cambios en payload.

4) Índices DB (coordinar con DBA)
   - Título: Índices en precorte_efectivo FK y limpieza duplicados
   - Descripción: crear idx selemti.precorte_efectivo(precorte_id); eliminar duplicado precorte(sesion_id); evaluar índice parcial en public.ticket(terminal_id,closing_date) WHERE closing_date IS NULL.
   - Archivos: migración SQL (no ejecutar aquí); validación con EXPLAIN.
   - Estimado: 0.5–1 día; Riesgos: bloat/locks.

5) Recepciones Inventario — API y alineación UI?BD
   - Título: Endpoints de recepciones y mapeo cab/det/lote
   - Descripción: definir API index/show/store; confirmar columnas (qty_pack, pack_size, lot, exp_date, temp, evidence) y relaciones; tests.
   - Archivos: app/Http/Controllers/Api/Inventory/ReceptionController.php; Requests; vistas Livewire (si aplica)
   - Estimado: 2–3 días; Riesgos: modelado.

6) CRUD Formas de Pago (admin)
   - Título: Endpoints CRUD de formas de pago (opcional)
   - Descripción: agregar POST/PUT/DELETE; policies de acceso; tests.
   - Archivos: Api\Caja\FormasPagoController; Requests; Policies
   - Estimado: 1–2 días; Riesgos: coherencia operativa.

7) CRUD Proveedores / Sucursales (API opcional)
   - Título: Exponer endpoints REST (si se requiere)
   - Descripción: crear controladores y requests; o consolidar Livewire con validaciones fuertes.
   - Archivos: Api\Catalogs\*; Requests; Policies
   - Estimado: 1–2 días; Riesgos: duplicidad con Livewire.

8) Tests Feature (Caja)
   - Título: Cobertura de preflight/precorte/conciliación/postcorte y fix de test home
   - Descripción: crear pruebas de flujo feliz/errores y ajustar test de ruta '/'; mocks de POS si aplica.
   - Archivos: tests/Feature/*
   - Estimado: 1–2 días; Riesgos: tiempo de orquestación.

Comandos sugeridos (no ejecutar)
- php artisan make:request; php artisan make:policy; php artisan test
- php artisan route:list; php artisan about
- php artisan migrate; php artisan db:seed (en staging, con DBA)

Reglas para PRs
- Branches: feat/<tema>, fix/<tema>, chore/<tema> (uno por objetivo)
- Commits pequeños y atómicos, mensajes claros (Convencional Commits si es posible)
- PRs con descripción: contexto, cambios, pruebas manuales, riesgos
- Revisión obligatoria (al menos 1 reviewer) y lista de verificación (checklist de pruebas)
- Prohibido cambiar .env en PRs; cambios de DB solo con migraciones planificadas y revisadas
