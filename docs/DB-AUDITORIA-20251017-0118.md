Auditoría técnica — Base de Datos (PostgreSQL)

Fecha: 2025-10-17 01:18

Alcance
- Solo lectura. No se ejecutaron migraciones/seeders.
- Esquemas objetivo: `public` y `selemti` (según código y `.env` esperado).

Configuración (código)
- `config/database.php:1` — conexión `pgsql` con `search_path` desde `DB_SCHEMA` (por defecto `public`).
- Código hace referencia explícita a esquemas:
  - `public`: `ticket`, `terminal`, `users`.
  - `selemti`: `sesion_cajon`, `precorte`, `precorte_efectivo`, `precorte_otros`, `postcorte`, `formas_pago`, vista `vw_conciliacion_sesion`.

Tablas/Vistas utilizadas (por controlador)
- Cajas: `app/Http/Controllers/Api/Caja/CajasController.php:1`
  - Lee: `public.terminal`, `public.users`, `selemti.sesion_cajon`, existencia en `selemti.precorte`, `selemti.postcorte`.
- Precorte: `app/Http/Controllers/Api/Caja/PrecorteController.php:1`
  - Lee: `selemti.sesion_cajon`, `public.ticket`, `selemti.precorte`.
  - Escribe: `selemti.precorte`, `selemti.precorte_efectivo`, `selemti.precorte_otros`.
- Postcorte: `app/Http/Controllers/Api/Caja/PostcorteController.php:1`
  - Escribe: `selemti.postcorte`; actualiza `selemti.sesion_cajon.estatus` a `CERRADA` si valida.
- Conciliación: `app/Http/Controllers/Api/Caja/ConciliacionController.php:1`
  - Lee: `selemti.vw_conciliacion_sesion`.
- Formas de pago: `app/Http/Controllers/Api/Caja/FormasPagoController.php:1`
  - Lee: `selemti.formas_pago` (solo activos).

Sugerencia de verificación (solo lectura, con aprobación previa)
- Confirmar `search_path` de la sesión (no destructivo):
  - SQL: `SHOW search_path;`
- Listar tablas en `public` y `selemti` (no destructivo):
  - SQL: `SELECT table_schema, table_name FROM information_schema.tables WHERE table_schema IN ('public','selemti') ORDER BY 1,2;`
- Describir columnas de tablas usadas (no destructivo):
  - Ej.: `SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_schema='selemti' AND table_name='precorte' ORDER BY ordinal_position;`
- Conteos rápidos (no destructivo) para dimensionamiento:
  - Ej.: `SELECT COUNT(*) FROM selemti.sesion_cajon;`

Notas operativas
- No escribir en tablas del POS. Los controladores de Caja hacen INSERT/UPDATE/DELETE; toda prueba debe aislarse o ejecutarse contra ambiente de staging.
- `.env` contiene credenciales/DB_SCHEMA; al documentarlo, redactar valores sensibles. Para confirmar configuración actual, solicitar aprobación para leer `.env` (solo lectura) y registrar aquí valores no sensibles (host, puerto, base, schema). 

Próximos pasos (propuestos, requieren aprobación)
- Ejecutar `SHOW search_path;` con el usuario de la app.
- Enumerar tablas/columnas de `selemti` y `public` para indexar el diccionario de datos base del módulo.
- Validar existencia de `vw_conciliacion_sesion`.

