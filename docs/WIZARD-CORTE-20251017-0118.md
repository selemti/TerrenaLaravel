Wizard de Cortes de Caja — Mapa y Hallazgos

Fecha: 2025-10-17 01:18

Vista y activación
- Vista principal: `resources/views/caja/cortes.blade.php:1`.
- Botón por fila genera atributos `data-*` y dispara `abrirWizard()` desde `public/assets/js/caja/main.js:1`.
- Modal incluido: `resources/views/caja/_wizard_modals.php:1` (IDs base sin prefijo `cz*`).

Flujo (Front)
- Módulo JS: `public/assets/js/caja/wizard.js:1` + `state.js:1` + `helpers.js:1` + `config.js:1`.
- Paso 1 — Precorte:
  - Render denoms (`DENOMS`), captura cantidades y no-efectivo.
  - Preflight: `GET/POST /api/caja/precortes/preflight/{sesion}` para validar tickets abiertos.
  - Crear/recuperar precorte: `POST /api/caja/precortes` (campos: `store_id`, `terminal_id`, `user_id`, `bdate`, `sesion_id`).
  - Guardar valores: `POST /api/caja/precortes/{id}` (`denoms_json`, declarados y `notas`).
- Paso 2 — Conciliación:
  - Datos: `GET /api/caja/conciliacion/{sesion_id}` (vista `vw_conciliacion_sesion`).
  - Banner “falta corte POS” y acción “Sincronizar POS”.
- Paso 3 — Postcorte:
  - Crear: `POST /api/caja/postcortes` (desde precorte).
  - Actualizar/validar: `POST /api/caja/postcortes/{id}` (veredictos, notas, validado=true).
  - Si valida, backend cierra sesión (`estatus='CERRADA'`).

Flujo (Back)
- PrecorteController: preflight, createLegacy (idempotente por sesión), updateLegacy (transacción: limpia e inserta denoms/otros y actualiza totales).
- PostcorteController: crea/actualiza totales comparando Declarado vs Sistema (intervalo apertura–cierre); puede cerrar sesión.
- ConciliacionController: devuelve registro de vista materializada o view SQL.

Problemas y riesgos identificados
- Inconsistencia de IDs del modal:
  - `wizard.js` inicializa `bootstrap.Modal` buscando `#czModalPrecorte`; el modal real es `#wizardPrecorte` (`_wizard_modals.php`). Aunque existen selectores alternos en varios `querySelector`, si la instancia del modal no se crea, el Wizard no abrirá correctamente.
- `puedeWizard()` siempre `true` (`public/assets/js/caja/mainTable.js:1`), exponiendo acciones de Wizard sin validar estado (desarrollo temporal). 
- Autenticación/Autorización API: Rutas `/api/caja/*` no están tras `auth` por defecto; riesgo alto de exposición en entornos accesibles.
- `store_id` hardcodeado a `1` (`mainTable.js:1`); falta obtener tienda desde backend/estado real.
- Encoding mojibake en UI (acentos), revisar fuentes/archivos y meta charset.

Recomendaciones específicas
- Unificar nomenclatura: usar `#wizardPrecorte` en `wizard.js`/`state.js` para init y referencias, o renombrar el modal a `#czModalPrecorte`. Evitar mezcla de selectores alternativos.
- Restaurar lógica de `puedeWizard()` (asignada/activa/precorte_listo/sin_postcorte) y tests UI.
- Proteger `routes/api.php` (grupo `/api/caja`) con `auth:sanctum` o middleware adecuado. Revisar `app/Http/Kernel.php` para registrar `ApiResponseMiddleware` correctamente.
- Reemplazar `store=1` por valor proveniente del backend (e.g., en `/api/caja/sesiones/activa` o en respuesta de `/api/caja/cajas`).
- Añadir manejo explícito de errores 412 `pos_cut_missing` (ya contemplado en `helpers.GET_SOFT`) para la transición a Paso 2.

Pruebas propuestas (solo lectura, con aprobación)
- Verificar `GET /api/caja/cajas?date=YYYY-MM-DD` devuelve `terminals` con `sesion_id`.
- Validar `GET /api/caja/precortes/preflight/{sesion}` devuelve `tickets_abiertos` y `bloqueo` esperados.
- Comprobar `GET /api/caja/conciliacion/{sesion}` (existe vista y campos).

